{
  "hash": "68759d9f4b1d1349013d3941bed55670",
  "result": {
    "markdown": "---\ntitle: \"Fitting Occupancy models with R-INLA\"\nformat: \n  html: \n    code-link: true\n    code-fold: true\n    code-tools: \n      source: false\n      toggle: true\n  pdf: default\nbibliography: references.bib\n---\n\n\nThis section describes the steps to fit occupancy models in [R-INLA](https://www.r-inla.org/) using simulated data (simulation details can be found in the `Data Simulation` tab).\n\n# Simple Spatial Occupancy Model\n\n*Model description goes in here ...*\n\n## Set up\n\nWe first load the data and prepare it in the format that is required by the INLA library.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(INLA)\nlibrary(inlabru)\nlibrary(fmesher)\nlibrary(tidyverse)\nlibrary(sf)\nlibrary(terra)\nlibrary(dplyr)\n\nSSOM <- read.csv(\"Occ_data_1.csv\")\nx_covariate <- terra::rast('raster data/x_covariat.tif')\ng_covariate <- terra::rast('raster data/g_covariat.tif')\n\n# Extract the covariate values (NOTE: adapt this if inlabru is used)\n\n# Convert to sf \nSSOM <- SSOM |>\n  st_as_sf(coords = c('x.loc','y.loc')) \n\n#evaluate covariartes at each coordinate\nSSOM = SSOM |> \n        mutate(terra::extract(x_covariate,st_coordinates(SSOM)),\n               terra::extract(g_covariate,st_coordinates(SSOM)))\n```\n:::\n\n::: {#tbl-t1 .cell layout-align=\"center\" tbl-cap='First 6 entries of the occupancy data'}\n::: {.cell-output-display}\n| cellid|  y| nvisits|geometry         |        x_s|        g_s|\n|------:|--:|-------:|:----------------|----------:|----------:|\n|      2|  0|       5|POINT (4.5 1.5)  |  0.0674760|  1.4913634|\n|      5|  3|       4|POINT (13.5 1.5) | -0.2770668|  0.9355086|\n|      6|  2|       3|POINT (16.5 1.5) | -0.4963150|  0.8894699|\n|      7|  4|       5|POINT (19.5 1.5) | -0.4927090|  0.7932032|\n|      9|  0|       1|POINT (25.5 1.5) | -0.2284233|  0.5705246|\n|     23|  0|       4|POINT (67.5 1.5) |  0.7247477| -0.1598709|\n:::\n:::\n\n\nCreate the mesh ... *add details*\n\n\n::: {.cell}\n\n```{.r .cell-code}\nboundary_sf = st_bbox(c(xmin = 0, xmax = 300, ymax = 0, ymin = 300)) |> \n  st_as_sfc()\n\nmesh = fm_mesh_2d(loc.domain = st_coordinates(boundary_sf)[,1:2],\n                    offset = c(-0.1, -.2),\n                    max.edge = c(15, 30))\nmatern <- inla.spde2.pcmatern(mesh,\n                              prior.range = c(100, 0.5),  \n                              prior.sigma = c(1, 0.5))\n```\n:::\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![](index_files/figure-html/unnamed-chunk-4-1.png){fig-align='center' width=384}\n:::\n:::\n\n\nCreate projector A matrix and make stacks .\n\n*add list of the arguments for building the stack (switch with* `inlabru` *details)*\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# A_sp <- inla.spde.make.A(mesh = mesh, \n#                       loc = SSOM[,c('x.loc','y.loc')] |> as.matrix())\n\nA_sp <- inla.spde.make.A(mesh = mesh, \n                      loc = st_coordinates(SSOM))\n\niset_sp <- inla.spde.make.index(name = \"spatial_field\", matern$n.spde)\n\n\nstk <- inla.stack(data=list(Ycounts = SSOM$y, # observed occurrences\n                            Ncounts = SSOM$nvisits, # number of visits\n                            det_cov = SSOM$x_s, # detection covariate\n                            Int_det = rep(1,length(SSOM$y))), # Baseline detection \n                  A=list(A_sp,1),  # the A matrix; the 1 is included to make the list(covariates)\n                  effects=list(c(list(Int_occ=1), #the Intercept\n                                 iset_sp),  #the spatial index\n                               #the covariates\n                               list(occ_cov = SSOM$x_s)), \n                  #this is a quick name so yo can call upon easily\n                  tag='ssom')\n```\n:::\n\n\nNow we define the model components (left hand side -observational model components; right hand side - state process components) and fit the model *(switch with* `inlabru` *details):*\n\n\n::: {.cell}\n\n```{.r .cell-code}\nformula_ssom <- inla.mdata(cbind(Ycounts,Ncounts),cbind(Int_det,det_cov)) ~  -1 + Int_occ +  occ_cov +  f(spatial_field, model=matern) \n\n\nmodel_ssom <- inla(formula_ssom, data=inla.stack.data(stk), \n                 family= '0binomialS',\n                 control.fixed =  list(prec = 1/2.72, prec.intercept = 1/2.72),\n                 control.predictor=list(A=inla.stack.A(stk),compute=TRUE),\n                 control.compute = list(dic = TRUE, waic = TRUE, config = TRUE),\n                 verbose = FALSE,\n                 control.family = list(control.link = list(model = \"logit\"),\n                                       link.simple = \"logit\",\n                 hyper = list(\n                   beta1 = list(param = c(0,1), initial = -1),\n                   beta2 = list(param = c(0,1/2.72)))\n                 )\n                 )\n```\n:::\n\n\n### Results\n\n*Show the summary results in* @tbl-ssom-tbl1:\n\n\n::: {#tbl-ssom-tbl1 .cell tbl-cap='summary results from output'}\n::: {.cell-output-display}\n|par        |   true|   mean| quant0.025| quant0.975|\n|:----------|------:|------:|----------:|----------:|\n|$\\beta_0$  |  -0.85|  -2.34|      -3.99|      -1.00|\n|$\\beta_1$  |   1.50|   1.14|       0.81|       1.47|\n|$\\alpha_0$ |   0.41|   0.35|       0.22|       0.48|\n|$\\alpha_1$ |   1.00|   0.11|      -0.01|       0.23|\n|$\\rho$     | 100.00| 203.39|     100.41|     383.38|\n|$\\sigma$   |   1.00|   1.55|       0.98|       2.40|\n:::\n:::\n\n\n*show some plots:*\n\n\n::: {.cell layout-align=\"center\"}\n::: {.cell-output-display}\n![Posterior densities](index_files/figure-html/fig-posterior-dens-ssom-1.png){#fig-posterior-dens-ssom fig-align='center' width=960}\n:::\n:::\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}